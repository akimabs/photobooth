<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wardah Product Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --primary-color: #c6e5e3;
        --accent-color: #e79ca5;
        --text-color: #6a4e4f;
        --bg-color: #fdfcfc;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Playfair Display", serif;
      }

      body {
        background: linear-gradient(135deg, #fef7f9 0%, #e4f5f3 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 50px;
      }

      .tabs {
        display: flex;
        justify-content: space-around;
        background: #fff;
        border-bottom: 2px solid var(--accent-color);
        padding: 0 10px;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        width: 100%;
        max-width: 400px;
      }

      .tab {
        padding: 14px 0;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
        background: none;
        border: none;
        outline: none;
        position: relative;
        flex: 1;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 999px;
      }

      .tab:hover {
        background-color: var(--primary-color);
      }

      .tab.active {
        color: var(--accent-color);
        font-weight: 600;
      }

      .tab.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 25%;
        width: 50%;
        height: 3px;
        background-color: var(--accent-color);
        border-radius: 2px;
      }

      .tab-content {
        background: #fff;
        padding: 20px;
        margin-top: 10px;
        width: 100%;
        max-width: 400px;
        border-radius: 16px;
        box-shadow: 0 6px 16px rgba(231, 156, 165, 0.2);
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .phone-frame {
        width: 100%;
        aspect-ratio: 9 / 16;
        position: relative;
        background: black;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      }

      #video,
      #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #controls {
        position: absolute;
        bottom: 0;
        z-index: 2;
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 10px;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        height: 80px;
        border-top: 1px solid #eec9c9;
      }

      .color-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--accent-color);
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .color-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(231, 156, 165, 0.4);
      }

      .coming-soon {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        background: linear-gradient(145deg, #fff0f4, #f7cdd4);
        font-size: 24px;
        color: var(--accent-color);
        font-weight: 600;
        text-shadow: 1px 1px 0 #ffffff;
      }

      #video,
      #canvas {
        visibility: hidden;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  </head>

  <body>
    <div class="tabs">
      <button class="tab active" data-tab="lipstick">Lipstick</button>
      <button class="tab" data-tab="foundation">Foundation</button>
      <button class="tab" data-tab="blush">Blush</button>
      <button class="tab" data-tab="eyeshadow">Eyeshadow</button>
    </div>

    <div class="tab-content">
      <div class="tab-panel active" id="lipstick">
        <div class="phone-frame">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="canvas"></canvas>
          <div id="controls"></div>
        </div>
      </div>
      <div class="tab-panel" id="foundation">
        <div class="phone-frame">
          <div class="coming-soon">Coming Soon ✨</div>
        </div>
      </div>
      <div class="tab-panel" id="blush">
        <div class="phone-frame">
          <div class="coming-soon">Coming Soon ✨</div>
        </div>
      </div>
      <div class="tab-panel" id="eyeshadow">
        <div class="phone-frame">
          <div class="coming-soon">Coming Soon ✨</div>
        </div>
      </div>
    </div>

    <script>
      const tabs = document.querySelectorAll(".tab");
      const panels = document.querySelectorAll(".tab-panel");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const selected = tab.getAttribute("data-tab");
          panels.forEach((panel) => {
            panel.classList.toggle("active", panel.id === selected);
          });
        });
      });

      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const controls = document.getElementById("controls");

      let selectedColor = "rgba(255, 0, 128, 0.5)";
      const lipstickColors = ["#B01228", "#C8A688", "#A3382D", "#A25D7A", "#F3B08B", "#FF8FA3", "#8A1C3B"];

      lipstickColors.forEach((hex) => {
        const btn = document.createElement("div");
        btn.className = "color-btn";
        btn.style.backgroundColor = hex;
        btn.onclick = () => (selectedColor = hexToRgba(hex, 0.5));
        controls.appendChild(btn);
      });

      function hexToRgba(hex, alpha) {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function drawLipColor(landmarks, color) {
        const outerLower = [61, 146, 91, 181, 84, 17, 314, 405, 321, 375, 291];
        const innerLower = [78, 95, 88, 178, 87, 14, 317, 402, 318, 324, 308];
        const outerUpper = [61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291];
        const innerUpper = [78, 191, 80, 81, 82, 13, 312, 311, 310, 415, 308];

        // Combine outer and inner paths for evenodd fill rule
        function drawAndFillSection(outerPts, innerPts) {
          ctx.beginPath();
          // Outer path
          outerPts.forEach((i, idx) => {
            const pt = landmarks[i];
            const x = pt.x * canvas.width;
            const y = pt.y * canvas.height;
            idx === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          });
          ctx.closePath();

          // Inner path (clockwise or counter-clockwise relative to outer)
          innerPts.forEach((i, idx) => {
            const pt = landmarks[i];
            const x = pt.x * canvas.width;
            const y = pt.y * canvas.height;
            idx === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          });
          ctx.closePath();

          ctx.fillStyle = color;
          ctx.globalAlpha = 0.5; // Revert to desired transparency
          ctx.fill("evenodd"); // Use 'evenodd' fill rule
        }

        drawAndFillSection(outerLower, innerLower);
        drawAndFillSection(outerUpper, innerUpper);
      }

      async function setupCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
          video.srcObject = stream;
          video.setAttribute("playsinline", true); // ← penting buat Android Safari & Chrome

          await new Promise((resolve) => {
            video.onloadedmetadata = () => {
              video.play().then(resolve);
            };
          });

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        } catch (err) {
          alert("Failed to acquire camera feed: " + err.name + ": " + err.message);
          throw err;
        }
      }

      const faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
      });

      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      faceMesh.onResults((results) => {
        // tampilkan video dan canvas saat data pertama kali tersedia
        video.style.visibility = "visible";
        canvas.style.visibility = "visible";

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.translate(canvas.width, 0); // Move origin to the right
        ctx.scale(-1, 1); // Flip horizontally
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        if (results.multiFaceLandmarks?.length > 0) {
          const landmarks = results.multiFaceLandmarks[0];
          const activeTab = document.querySelector(".tab.active").dataset.tab;
          if (activeTab === "lipstick") drawLipColor(landmarks, selectedColor);
        }
        ctx.restore(); // Restore to original state at the end
      });

      setupCamera().then(() => {
        const camera = new Camera(video, {
          onFrame: async () => await faceMesh.send({ image: video }),
          width: 1280,
          height: 720,
        });
        camera.start();
      });
    </script>
  </body>
</html>
